
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<!-- Mirrored from devlib.symbian.slions.net/s3/GUID-E87018CD-01B4-5886-87FC-CD25EE90587D.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 27 Mar 2020 06:18:01 GMT -->
<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><meta name="copyright" content="(C) Copyright 2011" /><meta name="DC.rights.owner" content="(C) Copyright 2011" /><meta name="DC.Type" content="concept" /><meta name="DC.Title" content="Central Repository Transactions" /><meta name="DC.Relation" scheme="URI" content="GUID-1C683226-C142-5C7B-BD20-060058352B08" /><meta name="DC.Relation" scheme="URI" content="GUID-724BA3CD-7648-51DF-9285-3AA7470987F4" /><meta name="DC.Relation" scheme="URI" content="GUID-998DCA78-2488-5D6D-B5B3-D86C52F32823" /><meta name="DC.Relation" scheme="URI" content="GUID-32E29020-1956-461A-B79A-1492E06049E7" /><meta name="DC.Relation" scheme="URI" content="GUID-FBCBF8A0-7922-5881-A1C5-5DB41630E75A" /><meta name="DC.Relation" scheme="URI" content="GUID-F8824165-4B33-50D1-9706-BD2438B5A2EE" /><meta name="DC.Relation" scheme="URI" content="GUID-50BA6AEB-E968-5CCA-8F5D-A65969263D90" /><meta name="DC.Format" content="XHTML" /><meta name="DC.Identifier" content="GUID-E87018CD-01B4-5886-87FC-CD25EE90587D" /><meta name="DC.Language" content="en" /><title>Central Repository Transactions </title><link href="css/s60/style.css" rel="stylesheet" type="text/css" /><link href="PLUGINS_ROOT/com.nokia.forum.library/css/category_design.html" rel="stylesheet" type="text/css" /></head><body><div class="body"><div class="contentLeft prTxt"><h1 class="pageHeading" id="GUID-E87018CD-01B4-5886-87FC-CD25EE90587D">Central Repository Transactions</h1><div><p>This topic describes the concepts of Central Repository transactions. </p> <div><h3 class="section-title">Overview of transactions </h3> <p>In a typical use case, a repository is accessed by several different applications for different purposes such as reading, updating, caching and backing up. These applications are regarded as having a client-server relationship with the repository. When multiple applications can access a repository there is a danger of concurrent write operations corrupting the data. To prevent this, applications access repositories within sessions and perform operations on a repository within subdivisions of a session called transactions. The concept of a transaction is borrowed from database programming and is designed to ensure that only one application can modify a repository at any one time. Operations performed within a transaction are virtual, operating on a copy of the repository, until the transaction is successfully committed and the actual repository is modified. Transactions conform to a model which prevents them from being committed concurrently, so maintaining data integity. </p> <p>Only the following operations are permitted within a transaction: </p> <ul><li id="GUID-A1CFE73C-6248-5B8E-A5F8-5125786EAF64"><a name="GUID-A1CFE73C-6248-5B8E-A5F8-5125786EAF64"><!-- --></a><p>Find() </p> </li> <li id="GUID-4D0AEFB5-FB08-591F-BA24-098E832B6FE0"><a name="GUID-4D0AEFB5-FB08-591F-BA24-098E832B6FE0"><!-- --></a><p>Get() </p> </li> </ul> <ul><li id="GUID-6001550D-DC06-5767-A03C-F6677D895ECF"><a name="GUID-6001550D-DC06-5767-A03C-F6677D895ECF"><!-- --></a><p>Set() </p> </li> <li id="GUID-28F16F3E-502D-52C1-A157-621EE4307466"><a name="GUID-28F16F3E-502D-52C1-A157-621EE4307466"><!-- --></a><p>Create() </p> </li> <li id="GUID-9E98BC2F-5E94-51EA-8FE7-DDADE388AE21"><a name="GUID-9E98BC2F-5E94-51EA-8FE7-DDADE388AE21"><!-- --></a><p>Delete() </p> </li> <li id="GUID-42BC1D3F-1CE7-5F76-8B9F-9276892D86BC"><a name="GUID-42BC1D3F-1CE7-5F76-8B9F-9276892D86BC"><!-- --></a><p>Move() </p> </li> </ul> <p>Transactions are either synchronous or asynchronous. As the programmer you are responsible for avoiding errors such as beginning a transaction within a transaction which will cause a leave. You do this by conforming to a transaction model. </p> <p>The recommended transaction model is the optimistic non-serialised transaction model. It works on the principle that any number of clients may start a transaction at the same time, but as soon as one transaction is committed, any other transactions fail and must be started again. </p> <p>A session is in various states: </p> <ul><li id="GUID-F0C23BCF-6528-5112-AB35-BEA53D7EA5EF"><a name="GUID-F0C23BCF-6528-5112-AB35-BEA53D7EA5EF"><!-- --></a><p>Not in transaction </p> </li> <li id="GUID-27922FAA-BF3F-5C06-9810-FE20C41474E1"><a name="GUID-27922FAA-BF3F-5C06-9810-FE20C41474E1"><!-- --></a><p>Active </p> </li> <li id="GUID-720E56F0-477D-5C4E-8FA3-7EEABDE0E718"><a name="GUID-720E56F0-477D-5C4E-8FA3-7EEABDE0E718"><!-- --></a><p>Failed </p> </li> </ul> <p>An asynchronous transaction involves two other states: </p> <ul><li id="GUID-17470F86-6FE8-5998-B7CA-546988BDE132"><a name="GUID-17470F86-6FE8-5998-B7CA-546988BDE132"><!-- --></a><p>Pending start </p> </li> <li id="GUID-7AB3E6B9-51C6-56ED-82E8-FF1A1805C54E"><a name="GUID-7AB3E6B9-51C6-56ED-82E8-FF1A1805C54E"><!-- --></a><p>Pending commit </p> </li> </ul> </div> <div><h3 class="section-title">Synchronous transactions </h3> <p>A synchronous transaction has the following structure. </p> <ul><li id="GUID-DE7AA608-AC0C-53BF-A009-3D179621193C"><a name="GUID-DE7AA608-AC0C-53BF-A009-3D179621193C"><!-- --></a><p>A session is initially in the state Not in transaction. </p> </li> <li id="GUID-178E4E88-02C6-5869-B344-514C14FBDB4F"><a name="GUID-178E4E88-02C6-5869-B344-514C14FBDB4F"><!-- --></a><p>Call the synchronous form of StartTransaction() with the single parameter EConcurrentReadWriteTransaction. </p> </li> <li id="GUID-91D3A638-114B-5DCA-8FB0-35B554797194"><a name="GUID-91D3A638-114B-5DCA-8FB0-35B554797194"><!-- --></a><p>The session changes state to Active. </p> </li> <li id="GUID-C32289CB-8EA9-53E0-84DD-881FCDC5FF99"><a name="GUID-C32289CB-8EA9-53E0-84DD-881FCDC5FF99"><!-- --></a><p>Manipulate the repository with the functions Get() Set() Find() etc covered above. </p> </li> <li id="GUID-2F9FA0A5-7624-5300-819D-45562AF5FFDA"><a name="GUID-2F9FA0A5-7624-5300-819D-45562AF5FFDA"><!-- --></a><p>The session continues in the Active state. The changes to the repository are cached but not actually applied during the Active state. You then either revoke or persist the changes. </p> </li> <li id="GUID-39F7530F-E9D9-5938-B9EB-B0AF8768E16F"><a name="GUID-39F7530F-E9D9-5938-B9EB-B0AF8768E16F"><!-- --></a><p>To revoke the changes, call CancelTransaction() </p> </li> <li id="GUID-B21F7C3F-E960-571A-A98E-933B96FA14D0"><a name="GUID-B21F7C3F-E960-571A-A98E-933B96FA14D0"><!-- --></a><p>The session returns to Not in transaction. </p> </li> <li id="GUID-6C4EF9E4-CE0A-542B-A564-72B6FF2BECB1"><a name="GUID-6C4EF9E4-CE0A-542B-A564-72B6FF2BECB1"><!-- --></a><p>To persist the changes, call the synchronous form of CommitTransaction() with the parameter aKeyInfo of type TUint32 This function returns success or an error message and its parameter holds information about the transaction. On success, the parameter holds the number of settings which were changed. On failure, the parameter holds the settings which caused failure in the form of a key or partial key. </p> </li> <li id="GUID-FD7629FE-C6AF-5F65-9376-353ADD2B87F7"><a name="GUID-FD7629FE-C6AF-5F65-9376-353ADD2B87F7"><!-- --></a><p>On success the session returns to Not in transaction. On failure it enters the Failed state. When a transaction fails, the operations already performed are discarded and no subsequent operations can reverse the failure. </p> </li> <li id="GUID-0BBDE613-761D-54F2-894B-3BEEAB587A95"><a name="GUID-0BBDE613-761D-54F2-894B-3BEEAB587A95"><!-- --></a><p>If the reason for failure was the success of another transaction, the error message is KErrLocked and the session is Not in transaction. You try the same sequence of function calls until you get a successful commit. </p> <p>If there was some other reason for failure you must close the transaction yourself. To do this, either call CancelTransaction() or else call CommitTransaction() a second time. </p> <p>There is sometimes reason to fail the transaction deliberately by calling FailTransaction() For instance you might want to generate failure after an unsuccessful Get() operation and then cancel the transaction. </p> </li> </ul> <div class="figure" id="GUID-B2011974-4A4F-58B4-BDCD-CAFBAC4E52A7"><img src="GUID-66E0B7F2-DEB4-5326-9DE0-5C0E253568AF_d0e440970_href.png" /><p class="figure-title"><strong>Figure: </strong>
             Synchronous transaction state diagram 
          </p></div> </div> <div><h3 class="section-title">Asynchronous transactions</h3> <p>Synchronous transactions have the disadvantage that a busy server may block the client thread before any action takes place. To avoid this problem you can use the slightly more complicated asynchronous transactions. An asynchronous transaction has the same structure as a synchronous one except that there are two new states Pending Start and Pending Commit where a transaction waits until the server is ready to communicate with it. The transition from Not in transaction to Active now proceeds like this. </p> <ul><li id="GUID-A90153AE-A050-5721-9513-DD9753B1DF61"><a name="GUID-A90153AE-A050-5721-9513-DD9753B1DF61"><!-- --></a><p>A session is initially in the state Not in transaction. </p> </li> <li id="GUID-1F494795-6391-5A0E-B057-820602C90233"><a name="GUID-1F494795-6391-5A0E-B057-820602C90233"><!-- --></a><p>Call the asynchronous form of StartTransaction() with the parameters EConcurrentReadWriteTransaction and aStatus of type <a href="GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-E0B34F3E-D4C4-3232-B8B1-7DB35B454646.html#GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-E0B34F3E-D4C4-3232-B8B1-7DB35B454646.html"><code class="apiname">TRequestStatus</code></a> This function returns void: success or the reasons for failure are determined from the state of aStatus after execution. </p> </li> <li id="GUID-C419B2EB-2D04-5B93-B01C-AB9107B52351"><a name="GUID-C419B2EB-2D04-5B93-B01C-AB9107B52351"><!-- --></a><p>The session changes state to Pending Start. Activity on the server will eventually promote the session to Active. </p> </li> <li id="GUID-5793F04F-4BED-5755-B678-A1CDF3AE1400"><a name="GUID-5793F04F-4BED-5755-B678-A1CDF3AE1400"><!-- --></a><p>Manipulate the repository with the functions Get(), Set(), Find() etc covered above. </p> </li> <li id="GUID-0210FDB7-FD3F-5A6F-90B0-B8DAD23960E3"><a name="GUID-0210FDB7-FD3F-5A6F-90B0-B8DAD23960E3"><!-- --></a><p>The session continues in the Active state. The changes to the repository are cached but not actually applied during the Active state. You then either revoke or persist the changes. </p> </li> <li id="GUID-617CA21B-89D5-5531-A9A4-83173FF66867"><a name="GUID-617CA21B-89D5-5531-A9A4-83173FF66867"><!-- --></a><p>To revoke the changes, call CancelTransaction() This call has different effects depending on whether it was called in the Pending Start state or the Active state. If it was called in the Pending Start state it sets aStatus to KErrCancel </p> </li> <li id="GUID-57E59324-D623-5F0E-9954-B7B6C045C63E"><a name="GUID-57E59324-D623-5F0E-9954-B7B6C045C63E"><!-- --></a><p>The session returns to Not in transaction. </p> </li> <li id="GUID-1E0463FC-81E0-574A-9585-11593FB31DD9"><a name="GUID-1E0463FC-81E0-574A-9585-11593FB31DD9"><!-- --></a><p>To persist the changes, call the asynchronous form of CommitTransaction() with the parameters aKeyInfo of type TUint32 and aStatus of type <a href="GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-E0B34F3E-D4C4-3232-B8B1-7DB35B454646.html#GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-E0B34F3E-D4C4-3232-B8B1-7DB35B454646.html"><code class="apiname">TRequestStatus</code></a> This function returns void. Its first parameter holds information about the transaction. </p> </li> <li id="GUID-87C8F64D-2FE3-53D3-956C-3211EF7B776B"><a name="GUID-87C8F64D-2FE3-53D3-956C-3211EF7B776B"><!-- --></a><p>On success, the aStatus parameter holds the number of settings which were changed. On failure, the parameter holds the settings which caused failure in the form of a key or partial key. The aStatus parameter is set to success or failure. </p> </li> <li id="GUID-4DE0D798-4B73-5EA2-B4DE-2DEDCE6CE55A"><a name="GUID-4DE0D798-4B73-5EA2-B4DE-2DEDCE6CE55A"><!-- --></a><p>If the reason for failure was the success of another transaction, aStatus is set to KErrLocked and the session is Not in transaction. You try the same sequence of function calls until you get a successful commit. </p> <p>If there was some other reason for failure you must close the transaction yourself. To do this, either call CancelTransaction() or else call CommitTransaction() a second time. </p> <p>There is sometimes reason to fail the transaction deliberately by calling FailTransaction() For instance you might want to generate failure after an unsuccessful Get() operation and then cancel the transaction. </p> </li> </ul> <div class="figure" id="GUID-70E4E2BC-3996-54B1-AC65-ECADFB4E66FE"><img src="GUID-D2CF64ED-0D85-5535-9A51-C127B10B07B2_d0e441134_href.png" /><p class="figure-title"><strong>Figure: </strong>
             Asynchronous Transaction State Diagram 
          </p></div> </div> <div><h3 class="section-title">Cleanup </h3> <p>There is a danger that a transaction might remain open for ever if it is opened by code which subsequently leaves. To avoid this possibility, the CCentralRepository class has two functions which cause the cleanup stack to end the transaction in the event of a leave. CleanupCancelTransactionPushL(), also named CleanupRollbackTransactionPushL(), causes a leave to be followed by a call to CancelTransaction(). CleanupFailTransactionPushL() causes a leave to be followed by a call to FailTransaction(). </p> </div> </div><h3>Related concepts</h3><ul><li><a href="GUID-1C683226-C142-5C7B-BD20-060058352B08.html">Central Repository Guide</a></li><li><a href="GUID-998DCA78-2488-5D6D-B5B3-D86C52F32823.html">Modifications to
                Keyspaces</a></li></ul><h3>Related information</h3><ul><li>Optimising Repository
                Access</li></ul></div></div><div class="footer"><p class="metadata">Last updated October 10th, 2009</p><hr /><div class="copy">Â© Nokia 2011.</div></div></body>
<!-- Mirrored from devlib.symbian.slions.net/s3/GUID-E87018CD-01B4-5886-87FC-CD25EE90587D.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 27 Mar 2020 06:18:02 GMT -->
</html>