
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<!-- Mirrored from devlib.symbian.slions.net/s3/GUID-E9E26499-1102-578E-93F6-A8E14181A25C.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 27 Mar 2020 06:19:25 GMT -->
<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><meta name="copyright" content="(C) Copyright 2011" /><meta name="DC.rights.owner" content="(C) Copyright 2011" /><meta name="DC.Type" content="concept" /><meta name="DC.Title" content="How to handle changes to the text view" /><meta name="DC.Relation" scheme="URI" content="GUID-32E29020-1956-461A-B79A-1492E06049E7" /><meta name="DC.Relation" scheme="URI" content="GUID-1DCA2F4D-ABE6-52A0-AC4E-5AAC1AB5909D" /><meta name="DC.Relation" scheme="URI" content="GUID-4F901F56-7F0E-4869-85CA-6109ED0AF5B7" /><meta name="DC.Relation" scheme="URI" content="GUID-4CBFA2E3-0EFC-5E10-A960-57A8FF9A6025" /><meta name="DC.Relation" scheme="URI" content="GUID-136540F0-108A-5794-A0FE-D95260F4E59B" /><meta name="DC.Format" content="XHTML" /><meta name="DC.Identifier" content="GUID-E9E26499-1102-578E-93F6-A8E14181A25C" /><meta name="DC.Language" content="en" /><title>How to handle changes to the text view </title><link href="css/s60/style.css" rel="stylesheet" type="text/css" /><link href="PLUGINS_ROOT/com.nokia.forum.library/css/category_design.html" rel="stylesheet" type="text/css" /></head><body><div class="body"><div class="contentLeft prTxt"><h1 class="pageHeading" id="GUID-E9E26499-1102-578E-93F6-A8E14181A25C">How to handle changes to the text view</h1><div><p>After a change has been made to the text layout, a reformat and redraw should normally take place, otherwise a panic will occur, as the text view needs to be kept up to date with changes to the text content. The following examples demonstrate which handling functions should be used to carry out the necessary reformatting.</p> <div><h3 class="section-title">Reformatting and redrawing after changes to the formatting of a block of text. </h3> <p> To reformat either from the start of the line or the start of the paragraph containing the cursor position and redraw the view, after changes to the formatting of a block of text, use the CTextView::HandleRangeFormatChangeL() function.</p> <p>In the following example, the code retrieves the current selection and formats it. </p> <pre class="codeblock">// Apply italics to the selected region
TCursorSelection cursorSelection;
charFormat.iFontSpec.iFontStyle.SetPosture(EPostureItalic); 
charFormatMask.SetAttrib(EAttFontPosture); // Want to set posture</pre> <p>When formatting text, set the attribute's value in the <a href="GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-3518B92C-D1BD-36D1-B447-728A1052292F.html#GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-3518B92C-D1BD-36D1-B447-728A1052292F.html"><code class="apiname">TCharFormat</code></a> object and set the corresponding bit in the format mask.</p> <ul><li id="GUID-62AF121F-3BC4-5874-8351-578E687C5ED9"><a name="GUID-62AF121F-3BC4-5874-8351-578E687C5ED9"><!-- --></a><p>Use CTextView::Selection() to get the start position and length of the selected region.</p> </li> <li id="GUID-6092691E-80AB-5E48-B3A5-260762848D16"><a name="GUID-6092691E-80AB-5E48-B3A5-260762848D16"><!-- --></a><p>Apply character formatting to the selection using CRichText::ApplyCharFormatL().</p> </li> <li id="GUID-0C61B3B0-9839-5F27-B1ED-D511D3D8AB6D"><a name="GUID-0C61B3B0-9839-5F27-B1ED-D511D3D8AB6D"><!-- --></a><p>After reformatting text, handle changes to the layout of the document by an appropriate change handling function. CTextView::HandleRangeFormatChangeL() deals with block reformatting and redraws the view, and is the appropriate change handling function here.</p> </li> </ul> <pre class="codeblock">cursorSelection=iTextView-&gt;Selection(); // get limits of selection
TInt lowerPos=cursorSelection.LowerPos();
TInt length=cursorSelection.Length();
// Apply format to selected region
iRichText-&gt;ApplyCharFormatL(charFormat,charFormatMask,lowerPos,length);
// Ensure selection is cancelled after reformatting
TInt cursorPos=cursorSelection.iCursorPos; // Get new cursor position
// Set pending selection of length zero
TCursorSelection pendingSelection(cursorPos,cursorPos);
// Zero length selection, beginning and ending at new cursor position
iTextView-&gt;SetPendingSelection(pendingSelection);
        // Cancels selection after reformatting complete 
iTextView-&gt;HandleRangeFormatChangeL(cursorSelection); // reformat everything from here</pre> <p><strong>Notes</strong> </p> <ul><li id="GUID-A1E0FEB8-C5B3-5B09-84C2-4B79BC1E9F04"><a name="GUID-A1E0FEB8-C5B3-5B09-84C2-4B79BC1E9F04"><!-- --></a><p><code class="codeph">CTextView</code>'s change handling functions do not cancel an existing selection. To do so, either of two functions can be used — <code class="codeph">CancelSelectionL()</code>, or, as demonstrated above, <code class="codeph">SetPendingSelection()</code>. <code class="codeph">SetPendingSelection()</code> sets the selection which should take effect after <code class="codeph">HandleRangeFormatChangeL()</code> or <code class="codeph">HandleInsertDeleteL()</code> has returned. If the selection's anchor and cursor positions are set to the new cursor position, this has the effect of cancelling any selection. This method has the advantage over calling <code class="codeph">CancelSelectionL()</code> in that the selected region is only drawn once, reducing the likelihood of flicker.</p> </li> <li id="GUID-630CD46C-1615-537D-8229-1852EA8AAC6C"><a name="GUID-630CD46C-1615-537D-8229-1852EA8AAC6C"><!-- --></a><p>Formatting can either be applied to the entire document (the default), or just to the visible part of it (the band). Setting the formatting to the band may be desirable when the document has expanded over a certain size. </p> </li> </ul> </div> <div><h3 class="section-title">Reformatting and redrawing after inserting, deleting or replacing text</h3> <p>To Reformat and redraw the view after inserting, deleting or replacing a block of text, use the CTextView::HandleInsertDeleteL() function.</p> <p>In the following example the code inserts several lines of text into the document, followed by a paragraph delimiter.</p> <ul><li id="GUID-989A336F-1E0B-5E9C-831A-5F1283C6B18D"><a name="GUID-989A336F-1E0B-5E9C-831A-5F1283C6B18D"><!-- --></a><p>Before inserting a paragraph delimiter at the end of the text, use CEditableText::DocumentLength() to find the document position of the final character in the document.</p> </li> <li id="GUID-13A1E9E3-194C-5AD8-832E-05D9C2FE3291"><a name="GUID-13A1E9E3-194C-5AD8-832E-05D9C2FE3291"><!-- --></a><p>Call CTextView::HandleInsertDeleteL() to handle the block insertion and cause a redraw.</p> </li> <li id="GUID-05D2B596-3760-569B-A128-91FC90934285"><a name="GUID-05D2B596-3760-569B-A128-91FC90934285"><!-- --></a><p>Use an object of class <a href="GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-E2ED2E4B-C428-355D-84CC-A4FA0ED50B74.html#GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-E2ED2E4B-C428-355D-84CC-A4FA0ED50B74.html"><code class="apiname">TCursorSelection</code></a> to indicate the start position and length of the inserted text. The second argument has a value of zero because no characters were deleted.</p> </li> </ul> <pre class="codeblock">// Insert lots of text
iRichText-&gt;InsertL(iRichText-&gt;DocumentLength(),_L(
    "To be, or not to be, that is the question "
    ...
    ..."));
iRichText-&gt;InsertL(iRichText-&gt;DocumentLength(),
    CEditableText::EParagraphDelimiter); // end para
TCursorSelection cursorSelection(0,iRichText-&gt;DocumentLength());
iTextView-&gt;HandleInsertDeleteL(cursorSelection,0); // Handle insertion</pre> </div> <div><h3 class="section-title">Reformatting and redrawing after a global change</h3> <p>To reformat and redraw the view after a global change has been made to the layout, use the CTextView::HandleGlobalChangeL() function. </p> <p>In the following example, the code sets the <em>formatted
        band</em> to the part of the document displayed in the view rectangle. </p> <pre class="codeblock">TBuf&lt;80&gt; message;
iLayout-&gt;SetAmountToFormat(CTextLayout::EFFormatBand);
iTextView-&gt;HandleGlobalChangeL(); // Global document change </pre> </div> <div><h3 class="section-title">Reformatting the whole document or visible text</h3> <p>To reformat the whole document, or just the visible text if formatting is set to the band only, use the CTextView::FormatTextL() function. </p> <p>In the following example, the code inserts several lines of text, with increased height to aid visibility, then sets the <em>formatted
        band</em>.</p> <ul><li id="GUID-721E9015-0F7E-59AD-980C-9CB5878AB544"><a name="GUID-721E9015-0F7E-59AD-980C-9CB5878AB544"><!-- --></a><p>The following code sets the font height to 200 twips and ensures that this height will be applied to all text subsequently inserted. All other character and paragraph formatting is taken from the system-provided default settings. </p> </li> <li id="GUID-345B17D2-381D-5049-968F-EE5DF872801C"><a name="GUID-345B17D2-381D-5049-968F-EE5DF872801C"><!-- --></a><p>Apply character formatting to the selection using CRichText::ApplyCharFormatL().</p> </li> <li id="GUID-CB155905-65EE-51B8-9627-98D120590E27"><a name="GUID-CB155905-65EE-51B8-9627-98D120590E27"><!-- --></a><p>Use CTextView::FormatTextL() to global reformat the document. Note that this function does not cause a redraw, which is appropriate here because the document contains no text.</p> </li> </ul> <pre class="codeblock">TCharFormat charFormat;
TCharFormatMask charFormatMask;
charFormatMask.SetAttrib(EAttFontHeight); // want to set height to 10 point (200 twips)
charFormat.iFontSpec.iHeight=200;    
iRichText-&gt;ApplyCharFormatL(charFormat,charFormatMask,0,1);
    // apply format from position 0, for 1 character
iTextView-&gt;FormatTextL();</pre> </div> </div></div></div><div class="footer"><p class="metadata">Last updated October 9th, 2009</p><hr /><div class="copy">© Nokia 2011.</div></div></body>
<!-- Mirrored from devlib.symbian.slions.net/s3/GUID-E9E26499-1102-578E-93F6-A8E14181A25C.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 27 Mar 2020 06:19:25 GMT -->
</html>