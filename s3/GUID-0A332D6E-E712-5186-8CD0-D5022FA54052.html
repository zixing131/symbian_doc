
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<!-- Mirrored from devlib.symbian.slions.net/s3/GUID-0A332D6E-E712-5186-8CD0-D5022FA54052.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 27 Mar 2020 06:07:32 GMT -->
<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><meta name="copyright" content="(C) Copyright 2011" /><meta name="DC.rights.owner" content="(C) Copyright 2011" /><meta name="DC.Type" content="concept" /><meta name="DC.Title" content="Migrating to V2 client-server APIs" /><meta name="abstract" content="Describes how to modify client-server implementations to use the new Version 2 client-server APIs instead of the deprecated Version 1 APIs." /><meta name="description" content="Describes how to modify client-server implementations to use the new Version 2 client-server APIs instead of the deprecated Version 1 APIs." /><meta name="DC.Relation" scheme="URI" content="GUID-32E29020-1956-461A-B79A-1492E06049E7" /><meta name="DC.Relation" scheme="URI" content="GUID-E3D2A6ED-8192-563D-8966-DD96B3AF1783" /><meta name="DC.Relation" scheme="URI" content="GUID-0DF9E318-BE97-531E-AB39-A7B5E8787C87" /><meta name="DC.Relation" scheme="URI" content="GUID-A63025D1-7FD4-5120-8A1F-537D6B70103D" /><meta name="DC.Relation" scheme="URI" content="GUID-3786D8E6-17A9-52E4-A8DF-CFCDC3039854" /><meta name="DC.Relation" scheme="URI" content="GUID-6047DB3F-DC92-51DF-9EEB-00E79E890B54" /><meta name="DC.Format" content="XHTML" /><meta name="DC.Identifier" content="GUID-0A332D6E-E712-5186-8CD0-D5022FA54052" /><meta name="DC.Language" content="en" /><title>Migrating
to V2 client-server APIs </title><link href="css/s60/style.css" rel="stylesheet" type="text/css" /><link href="PLUGINS_ROOT/com.nokia.forum.library/css/category_design.html" rel="stylesheet" type="text/css" /></head><body><div class="body"><div class="contentLeft prTxt"><h1 class="pageHeading" id="GUID-0A332D6E-E712-5186-8CD0-D5022FA54052">Migrating
to V2 client-server APIs</h1><div><p>Describes how to modify client-server implementations to use the
new Version 2 client-server APIs instead of the deprecated Version 1 APIs.</p>
<p>The new APIs have been introduced as part of the effort to provide a more
secure interface for client-server communications, and form an essential component
of Platform Security in Symbian platform. </p>
<ul>
<li id="GUID-C53A38E9-A821-577A-930A-F478954FF806"><a name="GUID-C53A38E9-A821-577A-930A-F478954FF806"><!-- --></a><p> <a href="#GUID-35D3BD7A-8C16-50C3-80AD-2422E3B92AAB">General points</a> </p> </li>
<li id="GUID-FD82A424-BDB5-5DE7-8904-C579C7683CA1"><a name="GUID-FD82A424-BDB5-5DE7-8904-C579C7683CA1"><!-- --></a><p> <a href="#GUID-0FA5EC5C-8F7B-5E95-BE28-CD0DB6BDCBEE">The Version 1 client-server APIs</a> </p> </li>
<li id="GUID-63746CDF-E64B-5BA0-A133-8DFD0FA9FCF5"><a name="GUID-63746CDF-E64B-5BA0-A133-8DFD0FA9FCF5"><!-- --></a><p> <a href="#GUID-8BDFF94E-80E6-5CAF-8CC0-04D7F74FAF43">The Version 2 client-server APIs</a> </p> </li>
<li id="GUID-87719C35-00EB-51BE-8D01-6955535C6B4A"><a name="GUID-87719C35-00EB-51BE-8D01-6955535C6B4A"><!-- --></a><p> <a href="#GUID-C5A1C9BA-7637-53EB-9898-A58336F87389">Changes to the client interface</a> </p> </li>
<li id="GUID-CFDDD4B4-DD54-5F9C-B60D-D361EA621670"><a name="GUID-CFDDD4B4-DD54-5F9C-B60D-D361EA621670"><!-- --></a><p> <a href="#GUID-450BE510-C3C9-5988-853B-1A03A84F0875">Changes to the server interface</a> </p> </li>
<li id="GUID-30E36FBF-25EA-5347-810E-D2C85F853CCD"><a name="GUID-30E36FBF-25EA-5347-810E-D2C85F853CCD"><!-- --></a><p> <a href="#GUID-07F7FFA6-D421-54E2-90F7-69F002702C46">Using RMessagePtr2</a> </p> </li>
<li id="GUID-A2E1CEF3-BD6F-594D-B4DC-098FBABBC6F4"><a name="GUID-A2E1CEF3-BD6F-594D-B4DC-098FBABBC6F4"><!-- --></a><p> <a href="#GUID-1ABF5DC6-A957-5623-93AB-CD7631A36A33">Migration quick reference</a> </p> </li>
</ul>
<div id="GUID-35D3BD7A-8C16-50C3-80AD-2422E3B92AAB"><h3 class="section-title">General points</h3> <p>The
user library, EUSER.DLL, makes both the Version 1 and Version 2 client-server
APIs available. However, it is possible to 'hide' the Version 1 APIs during
compilation by defining the C pre-processor macro <code class="codeph">__HIDE_IPC_V1__</code>. </p> <p>For
example, by adding the following line to a component's MMP file: </p> <pre class="codeblock">macro __HIDE_IPC_V1__</pre> <p>This
can also be done globally for all components in Symbian platform by defining
the macro in the platform's HRH file: </p> <pre class="codeblock">#define __HIDE_IPC_V1__</pre> <p>In
addition, the EUSER header files define the macro <code class="codeph">__IPC_V2_PRESENT__</code>,
which allows source code that still needs to compile with older Symbian platform
releases, to detect the presence of the new APIs, and use conditional compilation
as appropriate. </p> </div>
<div id="GUID-0FA5EC5C-8F7B-5E95-BE28-CD0DB6BDCBEE"><h3 class="section-title">The Version
1 client-server APIs</h3> <p>The following classes and functions are defined
as constituting the Version 1 client-server APIs: </p> <pre class="codeblock">class CSharableSession
class CSession
class CServer
class RMessagePtr
class RMessage
class RServer

RSessionBase::Share(TAttachMode aAttachMode=EExplicitAttach)
RSessionBase::Attach()
RSessionBase::Send(TInt aFunction,TAny* aPtr)
RSessionBase::SendReceive(TInt aFunction,TAny* aPtr,TRequestStatus&amp; aStatus) 
RSessionBase::SendReceive(TInt aFunction,TAny* aPtr)

RSubSessionBase::CreateSubSession(RSessionBase&amp;,TInt aFunction,const TAny* aPtr)
RSubSessionBase::Send(TInt aFunction,const TAny* aPtr)
RSubSessionBase::SendReceive(TInt aFunction,const TAny* aPtr,TRequestStatus&amp;)
RSubSessionBase::SendReceive(TInt aFunction,const TAny* aPtr)

RThread::GetDesLength(const TAny* aPtr)
RThread::GetDesMaxLength(const TAny* aPtr)
RThread::ReadL(const TAny* aPtr,TDes8&amp; aDes,TInt anOffset)
RThread::ReadL(const TAny* aPtr,TDes16 &amp;aDes,TInt anOffset)
RThread::WriteL(const TAny* aPtr,const TDesC8&amp; aDes,TInt anOffset)
RThread::WriteL(const TAny* aPtr,const TDesC16&amp; aDes,TInt anOffset)</pre> <p>The
following functions are considered part of the client-server Version 1 APIs,
when the target thread is in another process. Note that these APIs are <em>not</em> hidden
by the <code class="codeph">__HIDE_IPC_V1__</code> macro. </p> <pre class="codeblock">RThread::RequestComplete(TRequestStatus*&amp; aStatus,TInt aReason)
RThread::Kill(TInt aReason)
RThread::Terminate(TInt aReason)
RThread::Panic(const TDesC&amp; aCategory,TInt aReason)
      </pre> </div>
<div id="GUID-8BDFF94E-80E6-5CAF-8CC0-04D7F74FAF43"><h3 class="section-title">The Version
2 client-server APIs</h3> <p>The following classes and functions are defined
as constituting the Version 2 client-server APIs. </p> <pre class="codeblock">class CSession2
class CServer2
class RMessagePtr2
class RMessage2
class RServer2
class TIpcArgs

RSessionBase::Send(TInt aFunction,const TIpcArgs&amp; aArgs)
RSessionBase::SendReceive(TInt aFunction,const TIpcArgs&amp; aArgs, TRequestStatus&amp;)
RSessionBase::SendReceive(TInt aFunction, const TIpcArgs&amp; aArgs)
RSessionBase::ShareAuto()

RSubSessionBase::CreateSubSession(RSessionBase&amp;,TInt aFunction,const TIpcArgs&amp;)
RSubSessionBase::Send(TInt aFunction,const TIpcArgs&amp; aArgs)
RSubSessionBase::SendReceive(TInt aFunction,const TIpcArgs&amp; aArgs, TRequestStatus&amp;)
RSubSessionBase::SendReceive(TInt aFunction,const TIpcArgs&amp; aArgs)</pre> </div>
<div id="GUID-C5A1C9BA-7637-53EB-9898-A58336F87389"><h3 class="section-title">Changes to
the client interface</h3> <p>The client interface to a server consists
of a class derived either from <code class="codeph">RSessionBase</code> or <code class="codeph">RSubSessionBase</code>.
This section lists the changes required to the use of these classes. </p> <ul>
<li id="GUID-65CF4ED6-3133-5452-800C-F1EDA040B7C2"><a name="GUID-65CF4ED6-3133-5452-800C-F1EDA040B7C2"><!-- --></a><p> <a href="#GUID-F5FB0FB3-6868-5B26-99A5-62082BFA87FD">RSessionBase::Share()</a> </p> </li>
<li id="GUID-93211175-EBE0-5C2E-9F67-3BFF6E50E5DD"><a name="GUID-93211175-EBE0-5C2E-9F67-3BFF6E50E5DD"><!-- --></a><p> <a href="#GUID-68B92D5D-7786-51CD-9A3D-7C835FD64496">RSessionBase::Attach()</a> </p> </li>
<li id="GUID-596E1B2A-E1FF-553B-A257-A4091DD15F1A"><a name="GUID-596E1B2A-E1FF-553B-A257-A4091DD15F1A"><!-- --></a><p> <a href="#GUID-8AF1B8B3-F598-5318-B9F9-5C74EEE8FCC9">RSessionBase::Send() &amp; RSessionBase::SendReceive()</a> </p> </li>
<li id="GUID-E88F13D3-C4C9-5624-A90B-2CC3EA841D5D"><a name="GUID-E88F13D3-C4C9-5624-A90B-2CC3EA841D5D"><!-- --></a><p> <a href="#GUID-449D6257-772B-5E08-8E4B-40C11EAF8FBA">RSubSessionBase::CreateSubSession()</a> </p> </li>
<li id="GUID-B28619D3-BDE6-5434-AB33-3016BA200633"><a name="GUID-B28619D3-BDE6-5434-AB33-3016BA200633"><!-- --></a><p> <a href="#GUID-858A58D1-A539-55FB-855E-50B997BA9A41">RSubSessionBase::Send() &amp; RSubSessionBase::SendReceive()</a> </p> </li>
</ul> <p id="GUID-F5FB0FB3-6868-5B26-99A5-62082BFA87FD"><a name="GUID-F5FB0FB3-6868-5B26-99A5-62082BFA87FD"><!-- --></a><strong>RSessionBase::Share()</strong> </p> <div class="tablenoborder"><a name="GUID-175135E8-8583-53E4-8829-88738EEFA357"><!-- --></a><table cellpadding="4" cellspacing="0" summary="" id="GUID-175135E8-8583-53E4-8829-88738EEFA357" frame="border" border="1" rules="all">
<tbody>
<tr class="">
<td class="cellrowborder" valign="top"><p>Version 1 functions: </p> </td>
<td class="cellrowborder" valign="top"><pre class="codeblock">Share()
Share(EExplicitAttach)
Share(EAutoAttach)</pre> </td>
</tr>
<tr class="bg ">
<td class="cellrowborder" valign="top"><p>Version 2 function: </p> </td>
<td class="cellrowborder" valign="top"><pre class="codeblock">ShareAuto()</pre> </td>
</tr>
</tbody>
</table></div> <p>In Version 1, the two different share modes existed for historical
reasons. All sessions created with new Version 2 servers behave like the Version
1 <em>auto attach</em> sessions; there is no <em>explicit attach</em> sharing
mode. The new <code class="codeph">ShareAuto()</code> function should be used to replace
all occurrences of <code class="codeph">Share()</code>. </p> <p id="GUID-68B92D5D-7786-51CD-9A3D-7C835FD64496"><a name="GUID-68B92D5D-7786-51CD-9A3D-7C835FD64496"><!-- --></a><strong>RSessionBase::Attach()</strong> </p> <div class="tablenoborder"><a name="GUID-43575561-41F7-5F61-ADF2-06892D06941B"><!-- --></a><table cellpadding="4" cellspacing="0" summary="" id="GUID-43575561-41F7-5F61-ADF2-06892D06941B" frame="border" border="1" rules="all">
<tbody>
<tr class="">
<td class="cellrowborder" valign="top"><p>Version 1 function: </p> </td>
<td class="cellrowborder" valign="top"><pre class="codeblock">Attach()</pre> </td>
</tr>
<tr class="bg ">
<td class="cellrowborder" valign="top"><p>Version 2 function: </p> </td>
<td class="cellrowborder" valign="top"><p>NONE </p> </td>
</tr>
</tbody>
</table></div> <p>There is no explicit attach mode in the Version 2 API, (see <a href="#GUID-F5FB0FB3-6868-5B26-99A5-62082BFA87FD">RSessionBase::Share()</a>).
This means that all occurrences of <code class="codeph">Attach()</code> must be removed
from your code when migrating. </p> <p id="GUID-8AF1B8B3-F598-5318-B9F9-5C74EEE8FCC9"><a name="GUID-8AF1B8B3-F598-5318-B9F9-5C74EEE8FCC9"><!-- --></a><strong>RSessionBase::Send() &amp;
RSessionBase::SendReceive()</strong> </p> <div class="tablenoborder"><a name="GUID-BA09FDB1-4DF3-5D73-B314-1333E479FF35"><!-- --></a><table cellpadding="4" cellspacing="0" summary="" id="GUID-BA09FDB1-4DF3-5D73-B314-1333E479FF35" frame="border" border="1" rules="all">
<tbody>
<tr class="">
<td class="cellrowborder" valign="top"><p>Version 1 functions: </p> </td>
<td class="cellrowborder" valign="top"><pre class="codeblock">Send(TInt aFunction,TAny* aPtr)
SendReceive(TInt aFunction,TAny* aPtr,TRequestStatus&amp; aStatus)
SendReceive(TInt aFunction,TAny* aPtr)</pre> </td>
</tr>
<tr class="bg ">
<td class="cellrowborder" valign="top"><p>Version 2 functions: </p> </td>
<td class="cellrowborder" valign="top"><pre class="codeblock">Send(TInt aFunction,const TIpcArgs&amp; aArgs)
SendReceive(TInt aFunction,const TIpcArgs&amp; aArgs, TRequestStatus&amp; aStatus)
SendReceive(TInt aFunction, const TIpcArgs&amp; aArgs)</pre> </td>
</tr>
</tbody>
</table></div> <p>These are functions for sending request messages to a server.
Each of these messages can take up to <code class="codeph">KMaxMessageArguments</code> arbitrary
arguments (i.e. 4 arguments), and it is the packaging of these arguments which
has been changed in the Version 2 APIs. </p> <p>The Version 1 APIs take a <code class="codeph">TAny*</code>,
which points to a C array containing a <code class="codeph">KMaxMessageArguments</code> number
of 32-bit quantities, usually <code class="codeph">TAny</code> * or <code class="codeph">TInt</code> types.
This is an example Version 1 client function: </p> <pre class="codeblock">TInt RMySession::Write(TDes8C&amp; aDes, TInt aLength, TInt aMode)
    {
    TAny* args[KMaxMessageArguments];
    args[0]=&amp;aDes;
    args[1]=(TAny*)aLength;
    args[2]=(TAny*)aMode;
    return SendReceive(ERequestWrite, &amp;args[0]);
    }</pre> <p>The Version 2 APIs package all of the arguments into
a <code class="codeph">TIpcArgs</code> object. This has templated constructors that take
between 0 and 4 objects. The above example would be implemented like this
using the Version 2 APIs: </p> <pre class="codeblock">TInt RMySession::Write(TDes8&amp; aDes, TInt aLength, TInt aMode)
    {
    TIpcArgs args(&amp;aDes, aLength, aMode);
    return SendReceive(ERequestWrite, args);
    }</pre> <p>This could also be written in a shorter way: </p> <pre class="codeblock">TInt RMySession::Write(TDes8C&amp; aDes, TInt aLength, TInt aMode)
    {
    return SendReceive(ERequestWrite, TIpcArgs(&amp;aDes, aLength, aMode) );
    }</pre> <p>The <code class="codeph">TIpcArgs</code> object stores additional
type information for each argument, and this is used to validate a server's
usage of the arguments with the various <code class="codeph">RMessagePtr2::Read()</code> and <code class="codeph">RMessagePtr2::Write()</code> functions. </p> <p>If
you need to explicitly send an empty or unused argument to a server, then
use the <code class="codeph">ENothing</code> enumeration. For example: </p> <pre class="codeblock">TIpcArgs args(arg1, TIpcArgs::ENothing, arg3);</pre> <p>The
second argument will have an undefined value when the server receives the
message. </p> <p id="GUID-449D6257-772B-5E08-8E4B-40C11EAF8FBA"><a name="GUID-449D6257-772B-5E08-8E4B-40C11EAF8FBA"><!-- --></a><strong>RSubSessionBase::CreateSubSession()</strong> </p> <div class="tablenoborder"><a name="GUID-D11D839A-A6DC-56F6-A375-715C3C20DB58"><!-- --></a><table cellpadding="4" cellspacing="0" summary="" id="GUID-D11D839A-A6DC-56F6-A375-715C3C20DB58" frame="border" border="1" rules="all">
<tbody>
<tr class="">
<td class="cellrowborder" valign="top"><p>Version 1 function: </p> </td>
<td class="cellrowborder" valign="top"><pre class="codeblock">CreateSubSession(RSessionBase&amp; aSession,TInt aFunction,const TAny* aPtr)</pre> </td>
</tr>
<tr class="bg ">
<td class="cellrowborder" valign="top"><p>Version 2 function: </p> </td>
<td class="cellrowborder" valign="top"><pre class="codeblock">CreateSubSession(RSessionBase, TInt aFunction, const TIpcArgs&amp; aArgs)</pre> </td>
</tr>
</tbody>
</table></div> <p>The message arguments supplied to this function use a <code class="codeph">TIpcArgs</code> object
in Version 2. This is for the same reason as described in <a href="#GUID-8AF1B8B3-F598-5318-B9F9-5C74EEE8FCC9">RSessionBase::Send() &amp; RSessionBase::SendReceive()</a>. </p> <p id="GUID-858A58D1-A539-55FB-855E-50B997BA9A41"><a name="GUID-858A58D1-A539-55FB-855E-50B997BA9A41"><!-- --></a><strong>RSubSessionBase::Send()
&amp; RSubSessionBase::SendReceive()</strong> </p> <div class="tablenoborder"><a name="GUID-3357BA2C-42CF-5590-94EE-0AC5C46C463B"><!-- --></a><table cellpadding="4" cellspacing="0" summary="" id="GUID-3357BA2C-42CF-5590-94EE-0AC5C46C463B" frame="border" border="1" rules="all">
<tbody>
<tr class="">
<td class="cellrowborder" valign="top"><p>Version 1 functions: </p> </td>
<td class="cellrowborder" valign="top"><pre class="codeblock">Send(TInt aFunction,const TAny* aPtr)
SendReceive(TInt aFunction,const TAny* aPtr,TRequestStatus&amp;)
SendReceive(TInt aFunction,const TAny* aPtr)</pre> </td>
</tr>
<tr class="bg ">
<td class="cellrowborder" valign="top"><p>Version 2 functions: </p> </td>
<td class="cellrowborder" valign="top"><pre class="codeblock">Send(TInt aFunction,const TIpcArgs&amp; aArgs)
SendReceive(TInt aFunction,const TIpcArgs&amp; aArgs, TRequestStatus&amp;)
SendReceive(TInt aFunction,const TIpcArgs&amp; aArgs)</pre> </td>
</tr>
</tbody>
</table></div> <p>The message arguments supplied to this function use a <code class="codeph">TIpcArgs</code> object
in Version 2. This is for the same reason as described in <a href="#GUID-8AF1B8B3-F598-5318-B9F9-5C74EEE8FCC9">RSessionBase::Send() &amp; RSessionBase::SendReceive()</a>. </p> </div>
<div id="GUID-450BE510-C3C9-5988-853B-1A03A84F0875"><h3 class="section-title">Changes to
the server interface</h3> <p>This section details the changes required
to migrate a server implementation to the Version 2 APIs. These APIs have,
in nearly all cases, been implemented using the same class names as in Version
1, but with the addition of the suffix '2'. For example, <code class="codeph">CServer2</code> implements
the Version 2 APIs corresponding to the Version 1 functionality provided by <code class="codeph">CServer</code>. </p> <ul>
<li id="GUID-F2E4AB18-F24A-5EEF-B5CC-F8FBF947DE4E"><a name="GUID-F2E4AB18-F24A-5EEF-B5CC-F8FBF947DE4E"><!-- --></a><p> <a href="#GUID-43CF1E50-8E60-5633-97B7-B030D1DEC182">CServer</a> </p> </li>
<li id="GUID-7A262AF7-DBBD-5765-8179-F72E288304B2"><a name="GUID-7A262AF7-DBBD-5765-8179-F72E288304B2"><!-- --></a><p> <a href="#GUID-B05AFD51-FF98-5972-9F40-107D8F8FEA5A">CServer::NewSessionL()</a> </p> </li>
<li id="GUID-1E1E1D8C-5BA5-5116-99B0-41453000DEE5"><a name="GUID-1E1E1D8C-5BA5-5116-99B0-41453000DEE5"><!-- --></a><p> <a href="#GUID-77592C37-AF3E-59DE-981E-AF23B442163B">CSharableSession</a> </p> </li>
<li id="GUID-C02F715E-6DF6-5AB0-A607-D740F32ADCEF"><a name="GUID-C02F715E-6DF6-5AB0-A607-D740F32ADCEF"><!-- --></a><p> <a href="#GUID-1616B87E-A4C3-509B-AF79-D4A964032BF1">CSharableSession::CreateL()</a> </p> </li>
<li id="GUID-3D09C142-DCF5-5FC6-99CC-A54D2FBECFBF"><a name="GUID-3D09C142-DCF5-5FC6-99CC-A54D2FBECFBF"><!-- --></a><p> <a href="#GUID-868E4703-DD82-5145-809D-91908237266C">CSharableSession::ResourceCountMarkEnd()</a> </p> </li>
<li id="GUID-38A6E9AB-4804-5852-907D-264F0CDA6D0B"><a name="GUID-38A6E9AB-4804-5852-907D-264F0CDA6D0B"><!-- --></a><p> <a href="#GUID-54BF8797-7AE5-57E0-B5FD-C36C45D8CFFB">CSharableSession::RMessage()</a> </p> </li>
<li id="GUID-69440B22-6333-5783-A129-AFFFF7639068"><a name="GUID-69440B22-6333-5783-A129-AFFFF7639068"><!-- --></a><p> <a href="#GUID-F62D83DD-2A1C-5745-9813-E6646FF167BB">CSession</a> </p> </li>
<li id="GUID-12DC701E-E313-5CFA-9113-077423AE1CFE"><a name="GUID-12DC701E-E313-5CFA-9113-077423AE1CFE"><!-- --></a><p> <a href="#GUID-F0C1B0F6-BF72-5A52-84D1-E7E748D3E1A5">CSession::CSession()</a> </p> </li>
<li id="GUID-D1DE193D-A5E7-5A80-B317-2E657008B174"><a name="GUID-D1DE193D-A5E7-5A80-B317-2E657008B174"><!-- --></a><p> <a href="#GUID-F2BB351E-73DA-522A-96ED-361F2EB1A379">RMessage</a> </p> </li>
<li id="GUID-606187D7-226C-5919-86D9-7881540D30D6"><a name="GUID-606187D7-226C-5919-86D9-7881540D30D6"><!-- --></a><p> <a href="#GUID-B0431DFE-C0E5-5767-A299-564EC502B01E">RMessage::Client()</a> </p> </li>
<li id="GUID-06E2F69F-ABEE-5AB8-9751-45E285C3B494"><a name="GUID-06E2F69F-ABEE-5AB8-9751-45E285C3B494"><!-- --></a><p> <a href="#GUID-4EEFEF47-D875-5C16-8836-98DD03C0A91D">RMessage::MessagePtr()</a> </p> </li>
<li id="GUID-73BB6C0D-FEE3-5C9A-B2E6-7BFCD2C59C1B"><a name="GUID-73BB6C0D-FEE3-5C9A-B2E6-7BFCD2C59C1B"><!-- --></a><p> <a href="#GUID-8754F52F-371C-546B-9290-B5369E915318">RMessage::descriptor access methods</a> </p> </li>
<li id="GUID-CE72E73D-4BA9-566B-ABA0-6FC52F1E17EC"><a name="GUID-CE72E73D-4BA9-566B-ABA0-6FC52F1E17EC"><!-- --></a><p> <a href="#GUID-49869449-4440-5D20-97ED-32C14C5D1DAF">RMessagePtr</a> </p> </li>
<li id="GUID-F91895A2-E211-56AF-9DA8-372D312E5E1B"><a name="GUID-F91895A2-E211-56AF-9DA8-372D312E5E1B"><!-- --></a><p> <a href="#GUID-A94A9960-319C-51B5-B693-2538D3985004">RThread</a> </p> </li>
<li id="GUID-4C8AF2A5-72D9-5367-9A7E-3721CC94401F"><a name="GUID-4C8AF2A5-72D9-5367-9A7E-3721CC94401F"><!-- --></a><p> <a href="#GUID-9DA5C542-44B6-5277-837D-1D9150F43B10">RThread::RequestComplete()</a> </p> </li>
</ul> <p id="GUID-43CF1E50-8E60-5633-97B7-B030D1DEC182"><a name="GUID-43CF1E50-8E60-5633-97B7-B030D1DEC182"><!-- --></a><strong>CServer</strong> </p> <div class="tablenoborder"><a name="GUID-BD8385C6-AEAA-5379-87F3-F3B3A9CA5397"><!-- --></a><table cellpadding="4" cellspacing="0" summary="" id="GUID-BD8385C6-AEAA-5379-87F3-F3B3A9CA5397" frame="border" border="1" rules="all">
<tbody>
<tr class="">
<td class="cellrowborder" valign="top"><p>Version 1 class: </p> </td>
<td class="cellrowborder" valign="top"><pre class="codeblock">CServer</pre> </td>
</tr>
<tr class="bg ">
<td class="cellrowborder" valign="top"><p>Version 2 class: </p> </td>
<td class="cellrowborder" valign="top"><pre class="codeblock">CServer2</pre> </td>
</tr>
</tbody>
</table></div> <p>Simply replace <code class="codeph">CServer</code> with <code class="codeph">CServer2</code>. </p> <p id="GUID-B05AFD51-FF98-5972-9F40-107D8F8FEA5A"><a name="GUID-B05AFD51-FF98-5972-9F40-107D8F8FEA5A"><!-- --></a><strong>CServer::NewSessionL()</strong> </p> <div class="tablenoborder"><a name="GUID-1755D610-F3C5-50A8-9CE4-BE357883373B"><!-- --></a><table cellpadding="4" cellspacing="0" summary="" id="GUID-1755D610-F3C5-50A8-9CE4-BE357883373B" frame="border" border="1" rules="all">
<tbody>
<tr class="">
<td class="cellrowborder" valign="top"><p>Version 1 function: </p> </td>
<td class="cellrowborder" valign="top"><pre class="codeblock">CSharableSession* CServer::NewSessionL(const TVersion&amp; aVersion) const</pre> </td>
</tr>
<tr class="bg ">
<td class="cellrowborder" valign="top"><p>Version 2 function: </p> </td>
<td class="cellrowborder" valign="top"><pre class="codeblock">CSession2* CServer2::NewSessionL(const TVersion&amp; aVersion,const RMessage2&amp; aMessage) const</pre> </td>
</tr>
</tbody>
</table></div> <p>In Version 1, <code class="codeph">CServer::NewSessionL()</code> is implemented
by a class derived from <code class="codeph">CServer</code>. In Version 2, your derived
class uses <code class="codeph">CServer2</code> as the base class. </p> <p>The <code class="codeph">RMessage2</code> argument
in Version 2 is the 'connect' message from the client. It has been added to
allow implementations to check identity and security information about the
new client. </p> <p>This message argument can be ignored when migrating code
from the Version 1 APIs. </p> <p id="GUID-77592C37-AF3E-59DE-981E-AF23B442163B"><a name="GUID-77592C37-AF3E-59DE-981E-AF23B442163B"><!-- --></a><strong>CSharableSession</strong> </p> <div class="tablenoborder"><a name="GUID-3FE15D11-51FA-5B24-B153-47EF5B20C925"><!-- --></a><table cellpadding="4" cellspacing="0" summary="" id="GUID-3FE15D11-51FA-5B24-B153-47EF5B20C925" frame="border" border="1" rules="all">
<tbody>
<tr class="">
<td class="cellrowborder" valign="top"><p>Version 1 class: </p> </td>
<td class="cellrowborder" valign="top"><pre class="codeblock">CSharableSession</pre> </td>
</tr>
<tr class="bg ">
<td class="cellrowborder" valign="top"><p>Version 2 class: </p> </td>
<td class="cellrowborder" valign="top"><pre class="codeblock">CSession2</pre> </td>
</tr>
</tbody>
</table></div> <p>Simply replace <code class="codeph">CSharableSession</code> with <code class="codeph">CSession2</code>. </p> <p id="GUID-1616B87E-A4C3-509B-AF79-D4A964032BF1"><a name="GUID-1616B87E-A4C3-509B-AF79-D4A964032BF1"><!-- --></a><strong>CSharableSession::CreateL()</strong> </p> <div class="tablenoborder"><a name="GUID-7805C54A-7534-5C20-BE26-09575363F9C2"><!-- --></a><table cellpadding="4" cellspacing="0" summary="" id="GUID-7805C54A-7534-5C20-BE26-09575363F9C2" frame="border" border="1" rules="all">
<tbody>
<tr class="">
<td class="cellrowborder" valign="top"><p>Version 1 function: </p> </td>
<td class="cellrowborder" valign="top"><pre class="codeblock">void CSharableSession::CreateL(const CServer&amp; aServer)</pre> </td>
</tr>
<tr class="bg ">
<td class="cellrowborder" valign="top"><p>Version 2 function: </p> </td>
<td class="cellrowborder" valign="top"><pre class="codeblock">void CSession2::CreateL()</pre> </td>
</tr>
</tbody>
</table></div> <p>In Version 1, <code class="codeph">CSharableSession::CreateL()</code> can
be re-implemented by a class derived from <code class="codeph">CSharableSession</code>.
In Version 2, your derived class uses <code class="codeph">CSession2</code> as the base
class. </p> <p>The Version 2 <code class="codeph">CreateL()</code> function has no arguments.
If a derived session object overrides this function, then it will need modifying. </p> <p id="GUID-868E4703-DD82-5145-809D-91908237266C"><a name="GUID-868E4703-DD82-5145-809D-91908237266C"><!-- --></a><strong>CSharableSession::ResourceCountMarkEnd()</strong> </p> <div class="tablenoborder"><a name="GUID-0E84FAD2-8007-5EA6-BCBB-659E67B0E94D"><!-- --></a><table cellpadding="4" cellspacing="0" summary="" id="GUID-0E84FAD2-8007-5EA6-BCBB-659E67B0E94D" frame="border" border="1" rules="all">
<tbody>
<tr class="">
<td class="cellrowborder" valign="top"><p>Version 1 function: </p> </td>
<td class="cellrowborder" valign="top"><pre class="codeblock">void CSharableSession::ResourceCountMarkEnd()</pre> </td>
</tr>
<tr class="bg ">
<td class="cellrowborder" valign="top"><p>Version 2 function: </p> </td>
<td class="cellrowborder" valign="top"><pre class="codeblock">void CSession2::ResourceCountMarkEnd(const RMessage2&amp; aMessage)</pre> </td>
</tr>
</tbody>
</table></div> <p>In Version 2, the function requires a reference to the client
message that requested the resource check. This message is used to panic the
client if the check fails. </p> <p id="GUID-54BF8797-7AE5-57E0-B5FD-C36C45D8CFFB"><a name="GUID-54BF8797-7AE5-57E0-B5FD-C36C45D8CFFB"><!-- --></a><strong>CSharableSession::RMessage()</strong> </p> <div class="tablenoborder"><a name="GUID-342A2BD3-8446-5437-B785-47BD8071B307"><!-- --></a><table cellpadding="4" cellspacing="0" summary="" id="GUID-342A2BD3-8446-5437-B785-47BD8071B307" frame="border" border="1" rules="all">
<tbody>
<tr class="">
<td class="cellrowborder" valign="top"><p>Version 1 function: </p> </td>
<td class="cellrowborder" valign="top"><pre class="codeblock">const RMessage&amp; CSharableSession::Message() const</pre> </td>
</tr>
<tr class="bg ">
<td class="cellrowborder" valign="top"><p>Version 2 function: </p> </td>
<td class="cellrowborder" valign="top"><p>No equivalent function. </p> </td>
</tr>
</tbody>
</table></div> <p>In Version 1. this function returns a reference to the last message
delivered to the server. It is usually used by a session implementation to
mean <em>the current message being processed by the session</em>. </p> <p>This
function is not available in Version 2. When a session needs to manipulate
a message delivered to it, it should use the <code class="codeph">RMessage2</code> argument
passed to <code class="codeph">ServiceL()</code>, instead. Achieving this may require
passing this reference as an argument between function calls, or if that is
complex, then storing a reference to the message in the session object. </p> <p id="GUID-F62D83DD-2A1C-5745-9813-E6646FF167BB"><a name="GUID-F62D83DD-2A1C-5745-9813-E6646FF167BB"><!-- --></a><strong>CSession</strong> </p> <div class="tablenoborder"><a name="GUID-DB57B8A0-66D6-59CF-8DF6-15DBF0EDE488"><!-- --></a><table cellpadding="4" cellspacing="0" summary="" id="GUID-DB57B8A0-66D6-59CF-8DF6-15DBF0EDE488" frame="border" border="1" rules="all">
<tbody>
<tr class="">
<td class="cellrowborder" valign="top"><p>Version 1 class: </p> </td>
<td class="cellrowborder" valign="top"><pre class="codeblock">CSession</pre> </td>
</tr>
<tr class="bg ">
<td class="cellrowborder" valign="top"><p>Version 2 class: </p> </td>
<td class="cellrowborder" valign="top"><pre class="codeblock">CSession2</pre> </td>
</tr>
</tbody>
</table></div> <p>Replace <code class="codeph">CSession</code> with <code class="codeph">CSession2</code>. </p> <p>The
changes applicable to <code class="codeph">CSharableSession</code> derived classes also
apply to <code class="codeph">CSession</code> derived classes. See: </p> <ul>
<li id="GUID-5C5C37DF-5D39-571C-8998-43A3ECB48DA2"><a name="GUID-5C5C37DF-5D39-571C-8998-43A3ECB48DA2"><!-- --></a><p> <a href="#GUID-1616B87E-A4C3-509B-AF79-D4A964032BF1">CSharableSession::CreateL()</a> </p> </li>
<li id="GUID-F40EFC23-D7A3-5814-8660-DEE9E9CE7762"><a name="GUID-F40EFC23-D7A3-5814-8660-DEE9E9CE7762"><!-- --></a><p> <a href="#GUID-868E4703-DD82-5145-809D-91908237266C">CSharableSession::ResourceCountMarkEnd()</a> </p> </li>
<li id="GUID-74ED0DB9-10A1-5616-9CFE-3FE2A37F1905"><a name="GUID-74ED0DB9-10A1-5616-9CFE-3FE2A37F1905"><!-- --></a><p> <a href="#GUID-54BF8797-7AE5-57E0-B5FD-C36C45D8CFFB">CSharableSession::RMessage()</a> </p> </li>
</ul> <p>In addition, if you use the following <code class="codeph">CSession</code> functions,
then you will need to change your code to use the equivalent functions in
the <code class="codeph">RMessage2</code> and/or <code class="codeph">RMessagePtr2</code> classes.
See <a href="#GUID-07F7FFA6-D421-54E2-90F7-69F002702C46">Using
RMessagePtr2</a>. </p> <pre class="codeblock">void ReadL(const TAny* aPtr,TDes8&amp; aDes) const;
void ReadL(const TAny* aPtr,TDes8&amp; aDes,TInt anOffset) const;
void ReadL(const TAny* aPtr,TDes16&amp; aDes) const;
void ReadL(const TAny* aPtr,TDes16&amp; aDes,TInt anOffset) const;
void WriteL(const TAny* aPtr,const TDesC8&amp; aDes) const;
void WriteL(const TAny* aPtr,const TDesC8&amp; aDes,TInt anOffset) const;
void WriteL(const TAny* aPtr,const TDesC16&amp; aDes) const;
void WriteL(const TAny* aPtr,const TDesC16&amp; aDes,TInt anOffset) const;
void Panic(const TDesC&amp; aCategory,TInt aReason) const;
void Kill(TInt aReason) const;
void Terminate(TInt aReason) const;</pre> <p id="GUID-F0C1B0F6-BF72-5A52-84D1-E7E748D3E1A5"><a name="GUID-F0C1B0F6-BF72-5A52-84D1-E7E748D3E1A5"><!-- --></a><strong>CSession::CSession()</strong> </p> <div class="tablenoborder"><a name="GUID-8EE0CBE3-B5C4-54A4-9027-0DD37C00EDBD"><!-- --></a><table cellpadding="4" cellspacing="0" summary="" id="GUID-8EE0CBE3-B5C4-54A4-9027-0DD37C00EDBD" frame="border" border="1" rules="all">
<tbody>
<tr class="">
<td class="cellrowborder" valign="top"><p>Version 1 function: </p> </td>
<td class="cellrowborder" valign="top"><pre class="codeblock">CSession::CSession(RThread aClient)</pre> </td>
</tr>
<tr class="bg ">
<td class="cellrowborder" valign="top"><p>Version 2 function: </p> </td>
<td class="cellrowborder" valign="top"><p>No equivalent constructor. </p> </td>
</tr>
</tbody>
</table></div> <p>The Version 1 <code class="codeph">CSession</code> object stores a handle
for the client thread. This should no longer be required after moving over
to Version 2, and indeed, a constructor taking a thread handle as an argument
is not supplied. </p> <p id="GUID-F2BB351E-73DA-522A-96ED-361F2EB1A379"><a name="GUID-F2BB351E-73DA-522A-96ED-361F2EB1A379"><!-- --></a><strong>RMessage</strong> </p> <div class="tablenoborder"><a name="GUID-AE303124-F8E6-5814-ABF3-86CE010AEB0D"><!-- --></a><table cellpadding="4" cellspacing="0" summary="" id="GUID-AE303124-F8E6-5814-ABF3-86CE010AEB0D" frame="border" border="1" rules="all">
<tbody>
<tr class="">
<td class="cellrowborder" valign="top"><p>Version 1 class: </p> </td>
<td class="cellrowborder" valign="top"><pre class="codeblock">RMessage</pre> </td>
</tr>
<tr class="bg ">
<td class="cellrowborder" valign="top"><p>Version 2 class: </p> </td>
<td class="cellrowborder" valign="top"><pre class="codeblock">RMessage2</pre> </td>
</tr>
</tbody>
</table></div> <p>Replace <code class="codeph">RMessage</code> with <code class="codeph">RMessage2</code>. </p> <p>Note
that <code class="codeph">RMessage2</code> derives from <code class="codeph">RMessagePtr2</code> and
that most of the functions that were members of the Version 1 class <code class="codeph">RMessage</code> are
now implemented in the Version 2 class <code class="codeph">RMessagePtr2</code>. </p> <p id="GUID-B0431DFE-C0E5-5767-A299-564EC502B01E"><a name="GUID-B0431DFE-C0E5-5767-A299-564EC502B01E"><!-- --></a><strong>RMessage::Client()</strong> </p> <div class="tablenoborder"><a name="GUID-D8B43D00-689F-5A63-B2D8-89D74E2D5ACE"><!-- --></a><table cellpadding="4" cellspacing="0" summary="" id="GUID-D8B43D00-689F-5A63-B2D8-89D74E2D5ACE" frame="border" border="1" rules="all">
<tbody>
<tr class="">
<td class="cellrowborder" valign="top"><p>Version 1 function: </p> </td>
<td class="cellrowborder" valign="top"><pre class="codeblock">const RThread&amp; RMessage::Client() const</pre> </td>
</tr>
<tr class="bg ">
<td class="cellrowborder" valign="top"><p>Version 2 function: </p> </td>
<td class="cellrowborder" valign="top"><pre class="codeblock">TInt RMessage2::Client(RThread&amp; aClient, TOwnerType aOwnerType=EOwnerProcess) const</pre> <p>(Note that the function is implemented by the <code class="codeph">RMessagePtr2</code> base
class.) </p> </td>
</tr>
</tbody>
</table></div> <p>In Version 1, the kernel maintains a handle to the client thread
which can be extracted from a message by calling <code class="codeph">RMessage::Client()</code>. </p> <p>In
Version 2, this special handle is not present; instead, a function is provided
that explicitly opens a handle on the client thread. This should be treated
just like any other thread handle, i.e. <code class="codeph">Close()</code> should be
called on the handle when it is no longer needed. </p> <p>Here's an example
of its usage: </p> <pre class="codeblock">void CMySession::ServiceL(const RMessage2&amp; aMessage)
    {
    ...
    RThread clientThread;
    // Open a handle on the client thread. Leaving if there is an error.
    User::LeaveIfError(aMessage.Client(clientThread));
    // Do something with the handle. (Print its ID in this example)
    RDebug::Print(_L("Client Thread ID = %n"),clientThread.Id());
    // Close handle
    clientThread.Close();
    ...
    }</pre> <p> <strong>You need to carefully examine all uses of RMessage::Client(),
as most servers should not need to use this function after migrating to the
Version 2 APIs. This is because the use of thread handles in a Version 1 server
is likely to involve those functions that have been removed from the Version
2 APIs.</strong> See <a href="#GUID-A94A9960-319C-51B5-B693-2538D3985004">RThread</a> for
more information. </p> <p id="GUID-4EEFEF47-D875-5C16-8836-98DD03C0A91D"><a name="GUID-4EEFEF47-D875-5C16-8836-98DD03C0A91D"><!-- --></a><strong>RMessage::MessagePtr()</strong> </p> <div class="tablenoborder"><a name="GUID-C4466017-A740-505D-BFF2-90CCE1014878"><!-- --></a><table cellpadding="4" cellspacing="0" summary="" id="GUID-C4466017-A740-505D-BFF2-90CCE1014878" frame="border" border="1" rules="all">
<tbody>
<tr class="">
<td class="cellrowborder" valign="top"><p>Version 1 function: </p> </td>
<td class="cellrowborder" valign="top"><pre class="codeblock">const RMessagePtr RMessage::MessagePtr() const</pre> </td>
</tr>
<tr class="bg ">
<td class="cellrowborder" valign="top"><p>Version 2 function: </p> </td>
<td class="cellrowborder" valign="top"><p>No equivalent function. </p> </td>
</tr>
</tbody>
</table></div> <p> <code class="codeph">RMessage2</code> derives from <code class="codeph">RMessagePtr2</code>,
therefore an <code class="codeph">RMessagePtr2</code> can be simply constructed or assigned
directly from an <code class="codeph">RMessage2</code>. There is no need for an explicit
method of construction as was the case in the Version 1 APIs. </p> <p id="GUID-8754F52F-371C-546B-9290-B5369E915318"><a name="GUID-8754F52F-371C-546B-9290-B5369E915318"><!-- --></a><strong>RMessage::descriptor access
methods</strong> </p> <div class="tablenoborder"><a name="GUID-E584453B-6BC7-56C1-9FDB-E531A3BC0A8C"><!-- --></a><table cellpadding="4" cellspacing="0" summary="" id="GUID-E584453B-6BC7-56C1-9FDB-E531A3BC0A8C" frame="border" border="1" rules="all">
<tbody>
<tr class="">
<td class="cellrowborder" valign="top"><p>Version 1 functions: </p> </td>
<td class="cellrowborder" valign="top"><pre class="codeblock">void RMessage::ReadL(const TAny* aPtr,TDes8&amp; aDes) const;
void RMessage::ReadL(const TAny* aPtr,TDes8&amp; aDes,TInt anOffset) const;
void RMessage::ReadL(const TAny* aPtr,TDes16&amp; aDes) const;
void RMessage::ReadL(const TAny* aPtr,TDes16&amp; aDes,TInt anOffset) const;
void RMessage::WriteL(const TAny* aPtr,const TDesC8&amp; aDes) const;
void RMessage::WriteL(const TAny* aPtr,const TDesC8&amp; aDes,TInt anOffset) const;
void RMessage::WriteL(const TAny* aPtr,const TDesC16&amp; aDes) const;
void RMessage::WriteL(const TAny* aPtr,const TDesC16&amp; aDes,TInt anOffset) const;</pre> </td>
</tr>
<tr class="bg ">
<td class="cellrowborder" valign="top"><p>Version 2 functions: </p> </td>
<td class="cellrowborder" valign="top"><p>These functions are replaced by functions that take a message argument
index instead of a <code class="codeph">TAny*</code>. See <a href="#GUID-07F7FFA6-D421-54E2-90F7-69F002702C46">Using
RMessagePtr2</a>. </p> </td>
</tr>
</tbody>
</table></div> <p id="GUID-49869449-4440-5D20-97ED-32C14C5D1DAF"><a name="GUID-49869449-4440-5D20-97ED-32C14C5D1DAF"><!-- --></a><strong>RMessagePtr</strong> </p> <div class="tablenoborder"><a name="GUID-D7F81784-48AD-5896-8DFF-F71CCE379E1D"><!-- --></a><table cellpadding="4" cellspacing="0" summary="" id="GUID-D7F81784-48AD-5896-8DFF-F71CCE379E1D" frame="border" border="1" rules="all">
<tbody>
<tr class="">
<td class="cellrowborder" valign="top"><p>Version 1 class: </p> </td>
<td class="cellrowborder" valign="top"><pre class="codeblock">RMessagePtr</pre> </td>
</tr>
<tr class="bg ">
<td class="cellrowborder" valign="top"><p>Version 2 class: </p> </td>
<td class="cellrowborder" valign="top"><pre class="codeblock">RMessagePtr2</pre> </td>
</tr>
</tbody>
</table></div> <p>Replace <code class="codeph">RMessagePtr</code> with <code class="codeph">RMessagePtr2</code>. </p> <p>See <a href="#GUID-07F7FFA6-D421-54E2-90F7-69F002702C46">Using
RMessagePtr2</a>. </p> <p id="GUID-A94A9960-319C-51B5-B693-2538D3985004"><a name="GUID-A94A9960-319C-51B5-B693-2538D3985004"><!-- --></a><strong>RThread</strong> </p> <p>Calls
to the following functions need to be changed to use the equivalent functions
in a <code class="codeph">RMessage2</code> /<code class="codeph">RMessagePtr2</code> class. See <a href="#GUID-07F7FFA6-D421-54E2-90F7-69F002702C46">Using
RMessagePtr2</a>. </p> <pre class="codeblock">TInt RThread::GetDesLength(const TAny* aPtr) const
TInt RThread::GetDesMaxLength(const TAny* aPtr)
void RThread::ReadL(const TAny* aPtr,TDes8&amp; aDes,TInt anOffset) const
void RThread::ReadL(const TAny* aPtr,TDes16 &amp;aDes,TInt anOffset) const
void RThread::WriteL(const TAny* aPtr,const TDesC8&amp; aDes,TInt anOffset) const
void RThread::WriteL(const TAny* aPtr,const TDesC16&amp; aDes,TInt anOffset) const
void RThread::Kill(TInt aReason)
void RThread::Terminate(TInt aReason)
void RThread::Panic(const TDesC&amp; aCategory,TInt aReason)</pre> <p id="GUID-9DA5C542-44B6-5277-837D-1D9150F43B10"><a name="GUID-9DA5C542-44B6-5277-837D-1D9150F43B10"><!-- --></a><strong>RThread::RequestComplete()</strong> </p> <div class="tablenoborder"><a name="GUID-CB602E73-0C6F-51DC-88BB-CC2D334008DD"><!-- --></a><table cellpadding="4" cellspacing="0" summary="" id="GUID-CB602E73-0C6F-51DC-88BB-CC2D334008DD" frame="border" border="1" rules="all">
<tbody>
<tr class="">
<td class="cellrowborder" valign="top"><p>Version 1 function: </p> </td>
<td class="cellrowborder" valign="top"><pre class="codeblock">void RThread::RequestComplete(TRequestStatus*&amp; aStatus,TInt aReason) const</pre> </td>
</tr>
<tr class="bg ">
<td class="cellrowborder" valign="top"><p>Version 2 function: </p> </td>
<td class="cellrowborder" valign="top"><pre class="codeblock">void RMessagePtr2::Complete(TInt aReason) const</pre> </td>
</tr>
</tbody>
</table></div> <p>With the Version 2 APIs, the only way of signalling a client's
request status in a different process is by completing a message sent by the
client to the session. This means that a call to <code class="codeph">RThread::RequestComplete()</code> should
be replaced by a call to <code class="codeph">RMessagePtr2::Complete()</code>. This requires
some minor changes to the internal architecture of the server. </p> <p>An
example of a call to <code class="codeph">RThread::RequestComplete()</code> is where
a server implements a kind of notification service, where a client asks to
be signalled when some event or change of state occurs. </p> <p><strong>A
version 1 server implementation</strong> </p> <p>In a Version 1 server implementation,
the notification scheme is often implemented with code similar to this: </p> <p>Client
function: </p> <pre class="codeblock">TInt RMySession::NotifyChanges(TRequestStatus&amp; aStatus)
    {
    TAny* args[KMaxMessageArguments];
    args[0]=&amp;aStatus;
    return SendReceive(ERequestNotifyChanges, &amp;args[0]);
    }</pre> <p>The server processes the request like this: </p> <pre class="codeblock">void CMySession::ServiceL(const RMessage&amp; aMessage)
    {
    ...
    // Get arguments needed to signal client
    RThread clientThread = aMessage.Client();
    TRequestStatus* clientStatus = (TRequestStatus*)aMessage.Ptr0();
    // Make notify object
    TMyNotifyChanges notifyObject(clientThread,clientStatus);
    // Add notify object to list of all requests
    TInt result=AddNotification(notifyObject);
    // Complete request message
    aMessage.Complete(result);
    ...
    }</pre> <p>When the event happens, clients are notified: </p> <pre class="codeblock">void CMySession::SignalNotifications(TInt aResult)
    {
    TMyNotifyChanges* notifyObject;
    while(notifyObject=RemoveNotifyObject())
        {
        // Complete each NotifyChanges object
        RThread clientThread = notifyObject-&gt;ClientThread();
        TRequestStatus* clientStatus = notifyObject-&gt;ClientStatus();
        clientThread.RequestComplete(clientStatus,aResult);
        }
    }</pre> <p><strong>A
version 2 server implementation</strong> </p> <p>In a Version 2 server implementation,
the notification scheme could be implemented using the Version 2 APIs like
this: </p> <p>Client function: </p> <pre class="codeblock">void RMySession::NotifyChanges(TRequestStatus&amp; aStatus)
    {
    TIpcArgs args();   // No arguments
    // Use asynchronous SendReceive for request
    SendReceive(ERequestNotifyChanges, args, aStatus);
    // void return type because errors will be signalled through aStatus
    }</pre> <p>The server processes the request like this: </p> <pre class="codeblock">void CMySession::ServiceL(const RMessage2&amp; aMessage)
    {
    ...
    RMessagePtr2 messagePtr = aMessage;
    // Make notify object
    TMyNotifyChanges notifyObject(messagePtr);
    // Add notify object to list of all requests
    TInt result=AddNotification(notifyObject);
    // Complete request message (only if error)
    if(result!=KErrNone)
        {
        aMessage.Complete(result);
        }
    ...
    }</pre> <p>When the event happens, clients will be notified: </p> <pre class="codeblock">void CMySession::SignalNotifications(TInt aResult)
    {
    TMyNotifyChanges* notifyObject;
    while(notifyObject=RemoveNotifyObject())
        {
        // Complete each NotifyChanges object
        RMessagePtr2 messagePtr = notifyObject-&gt;MessagePtr();
        messagePtr.Complete(aResult)
        }
    }</pre> </div>
<div id="GUID-07F7FFA6-D421-54E2-90F7-69F002702C46"><h3 class="section-title">Using RMessagePtr2</h3> <p>In
Version 2, a server's interaction with its clients is channelled through <code class="codeph">RMessagePtr2</code>,
from which <code class="codeph">RMessage2</code> is derived. An <code class="codeph">RMessagePtr2</code> object
acts as a handle to the message that the client has sent. The details of the
original message are maintained within the kernel so that it can enforce correct
use of the <code class="codeph">RMessagePtr2</code> functions. </p> <p>The <code class="codeph">RThread</code> and <code class="codeph">RSession</code> functions
for accessing descriptors, panicking the client and completing requests are
not available in Version 2. Instead, this functionality is provided by <code class="codeph">RMessagePtr2</code>.
Because of this, server implementations may need to have a reference to the
message available in many places. This may be done by passing such references
as arguments between functions or by storing a reference in the session object
processing the request. </p> <ul>
<li id="GUID-522FC7B3-A4BA-5507-9BD3-05CBAE0DDED8"><a name="GUID-522FC7B3-A4BA-5507-9BD3-05CBAE0DDED8"><!-- --></a><p> <a href="#GUID-5D18833F-55D6-50C1-94DB-569F5CA30ECB">Descriptor access functions</a> </p> </li>
<li id="GUID-D78F8B64-0E73-56EC-A40D-FC7E8FB1D722"><a name="GUID-D78F8B64-0E73-56EC-A40D-FC7E8FB1D722"><!-- --></a><p> <a href="#GUID-4BCF7E62-3ACA-535C-B201-84E570F95DE1">RMessagePtr2::Complete()</a> </p> </li>
<li id="GUID-5DFDDBFB-41AE-5EBC-943A-528C1C42312F"><a name="GUID-5DFDDBFB-41AE-5EBC-943A-528C1C42312F"><!-- --></a><p> <a href="#GUID-460A24B8-6BA3-5059-BE3B-FF9287ACF965">RMessagePtr2::Kill()</a> </p> </li>
<li id="GUID-A21E615F-A19C-5673-A7A0-372309AC944F"><a name="GUID-A21E615F-A19C-5673-A7A0-372309AC944F"><!-- --></a><p> <a href="#GUID-FD417FCA-8EC2-568F-A848-1F5712828E7D">RMessagePtr2::Terminate()</a> </p> </li>
<li id="GUID-CC7E6514-B7C0-507D-902C-2FE3F8EE1D36"><a name="GUID-CC7E6514-B7C0-507D-902C-2FE3F8EE1D36"><!-- --></a><p> <a href="#GUID-3005E91E-1930-5092-B89D-60772D5BD9CA">RMessagePtr2::Panic()</a> </p> </li>
</ul> <p id="GUID-5D18833F-55D6-50C1-94DB-569F5CA30ECB"><a name="GUID-5D18833F-55D6-50C1-94DB-569F5CA30ECB"><!-- --></a><strong>Descriptor access functions</strong> </p> <pre class="codeblock">TInt RMessagePtr2::GetDesLength(TInt aParam) const;
TInt RMessagePtr2::GetDesMaxLength(TInt aParam) const;
void RMessagePtr2::ReadL(TInt aParam,TDes8&amp; aDes,TInt aOffset=0) const;
void RMessagePtr2::ReadL(TInt aParam,TDes16 &amp;aDes,TInt aOffset=0) const;
void RMessagePtr2::WriteL(TInt aParam,const TDesC8&amp; aDes,TInt aOffset=0) const;
void RMessagePtr2::WriteL(TInt aParam,const TDesC16&amp; aDes,TInt aOffset=0) const;
TInt RMessagePtr2::Read(TInt aParam,TDes8&amp; aDes,TInt aOffset=0) const;
TInt RMessagePtr2::Read(TInt aParam,TDes16 &amp;aDes,TInt aOffset=0) const;
TInt RMessagePtr2::Write(TInt aParam,const TDesC8&amp; aDes,TInt aOffset=0) const;
TInt RMessagePtr2::Write(TInt aParam,const TDesC16&amp; aDes,TInt aOffset=0) const</pre> <p>These
are used in the same way as the equivalent <code class="codeph">RThread</code> functions
in the Version 1 APIs, except that instead of referring to the descriptor
by an address in the client, the <code class="codeph">aParam</code> argument is used.
This is a value between 0 and 3 and indicates which of the four arguments
in the original client message contains the pointer to the descriptor. </p> <p>For
example, if a client sends a message using code like this </p> <pre class="codeblock">TInt RMySession::Write(TDes8C&amp; aDes, TInt aLength)
    {
    return SendReceive(ERequestWrite, TIpcArgs(&amp;aDes, aLength) );
    }</pre> <p>then the server would access <code class="codeph">aDes</code> using
an <code class="codeph">aParam</code> value of 0. </p> <pre class="codeblock">void CMySession::ServiceL(const RMessage2&amp; aMessage)
    {
    ...
    TInt length=aMessage.Int1();  // Get length from message param 1
    TPtr8 buffer=MyNewBufferL(length);  // Make a new buffer for the data
    aMessage.ReadL(0,buffer);  // Read data from client descriptor (param 0)
    ...</pre> <p>Because <code class="codeph">TIpcArgs</code> also stores type
information about arguments, the kernel knows that argument 0 in the above
message is an 8-bit constant descriptor. On Symbian platforms
using the EKA2 kernel, this information is used to enforce correct usage of
descriptor access methods; in this case, trying to write to <code class="codeph">aDes</code>,
or treating it as a 16-bit descriptor would fail with <code class="codeph">KErrBadDescriptor</code>.
(The latter case would have allowed access to data beyond the length of the
8- bit descriptor. </p> <p>Note, both leaving and non-leaving versions of
the <code class="codeph">Read()</code> and <code class="codeph">Write()</code> functions are provided.
This allows the removal of some TRAP statements in code after migration to
the Version 2 APIs. </p> <p id="GUID-4BCF7E62-3ACA-535C-B201-84E570F95DE1"><a name="GUID-4BCF7E62-3ACA-535C-B201-84E570F95DE1"><!-- --></a><strong>RMessagePtr2::Complete()</strong> </p> <pre class="codeblock">void RMessagePtr2::Complete(TInt aReason) const;</pre> <p>This
function signals completion of the client request, in the same way that <code class="codeph">RMessage::Complete()</code> does
in Version 1. After completion, the <code class="codeph">iHandle</code> member is set
to zero, and this means that <code class="codeph">RMessagePtr2::Handle()</code> returns
zero, and <code class="codeph">RMessagePtr2::IsNull()</code> returns True. </p> <p>It
is important to note that once a message has been completed, it cannot be
used by the server, and any such attempt results in a KERN-EXEC 44 panic (Bad
Message Handle). To avoid this situation, implementations may need to check <code class="codeph">RMessagePtr2::IsNull()</code>,
but be aware that any copies of the message made before completion will not
have had their handles nulled. For this reason, it is best to avoid making
copies of <code class="codeph">RMessage2</code> or <code class="codeph">RMessagePtr2</code> objects,
this includes passing them as arguments to other functions 'by value'. Use
references instead. </p> <p id="GUID-460A24B8-6BA3-5059-BE3B-FF9287ACF965"><a name="GUID-460A24B8-6BA3-5059-BE3B-FF9287ACF965"><!-- --></a><strong>RMessagePtr2::Kill()</strong> </p> <pre class="codeblock">void RMessagePtr2::Kill(TInt aReason) const;</pre> <p>This
function is used in the same way as the equivalent <code class="codeph">RMessage</code> or <code class="codeph">RThread</code> functions
in Version 1. Note that this function also performs the action of <a href="#GUID-4BCF7E62-3ACA-535C-B201-84E570F95DE1">RMessagePtr2::Complete()</a>, so care must be taken that the message is
not used again. </p> <p id="GUID-FD417FCA-8EC2-568F-A848-1F5712828E7D"><a name="GUID-FD417FCA-8EC2-568F-A848-1F5712828E7D"><!-- --></a><strong>RMessagePtr2::Terminate()</strong> </p> <pre class="codeblock">void RMessagePtr2::Terminate(TInt aReason) const;</pre> <p>This
function is used in the same way as the equivalent <code class="codeph">RMessage</code> or <code class="codeph">RThread</code> functions
in Version 1. Note that this function also performs the action of <a href="#GUID-4BCF7E62-3ACA-535C-B201-84E570F95DE1">RMessagePtr2::Complete()</a>, so care must be taken that the message is
not used again. </p> <p id="GUID-3005E91E-1930-5092-B89D-60772D5BD9CA"><a name="GUID-3005E91E-1930-5092-B89D-60772D5BD9CA"><!-- --></a><strong>RMessagePtr2::Panic()</strong> </p> <pre class="codeblock">void RMessagePtr2::Panic(const TDesC&amp; aCategory,TInt aReason) const;</pre> <p>This
function is used in the same way as the equivalent <code class="codeph">RMessage</code> or <code class="codeph">RThread</code> functions
in Version 1. Note that this function also performs the action of <a href="#GUID-4BCF7E62-3ACA-535C-B201-84E570F95DE1">RMessagePtr2::Complete()</a>, so care must be taken that the message is
not used again. </p> </div>
<div id="GUID-1ABF5DC6-A957-5623-93AB-CD7631A36A33"><h3 class="section-title">Migration quick
reference</h3> <p>This is a quick reference to show you which Version 2
APIs you should use to replace the Version 1 APIs. </p> <div class="tablenoborder"><a name="GUID-0DAF9004-8A70-5F88-899D-996CC96090CC"><!-- --></a><table cellpadding="4" cellspacing="0" summary="" id="GUID-0DAF9004-8A70-5F88-899D-996CC96090CC" frame="border" border="1" rules="all">
<tbody>
<tr class="">
<td class="cellrowborder" valign="top"><p> <strong>Version 1 (where used)</strong> </p> </td>
<td class="cellrowborder" valign="top"><p> <strong>Version 2 (replace with...)</strong> </p> </td>
</tr>
<tr class="bg ">
<td class="cellrowborder" valign="top"><p> <code class="codeph">CSharableSession</code> </p> </td>
<td class="cellrowborder" valign="top"><p> <code class="codeph">CSession2</code> </p> </td>
</tr>
<tr class="">
<td class="cellrowborder" valign="top"><p> <code class="codeph">CSession</code> </p> </td>
<td class="cellrowborder" valign="top"><p> <code class="codeph">CSession2</code> </p> </td>
</tr>
<tr class="bg ">
<td class="cellrowborder" valign="top"><p> <code class="codeph">CServer</code> </p> </td>
<td class="cellrowborder" valign="top"><p> <code class="codeph">CServer2</code> </p> </td>
</tr>
<tr class="">
<td class="cellrowborder" valign="top"><p> <code class="codeph">RMessagePtr</code> </p> </td>
<td class="cellrowborder" valign="top"><p> <code class="codeph">RMessagePtr2</code> </p> </td>
</tr>
<tr class="bg ">
<td class="cellrowborder" valign="top"><p> <code class="codeph">RMessage</code> </p> </td>
<td class="cellrowborder" valign="top"><p> <code class="codeph">RMessage2</code> </p> </td>
</tr>
<tr class="">
<td class="cellrowborder" valign="top"><p> <code class="codeph">RServer</code> </p> </td>
<td class="cellrowborder" valign="top"><p> <code class="codeph">RServer2</code> </p> </td>
</tr>
<tr class="bg ">
<td class="cellrowborder" valign="top"><p> <code class="codeph">RThread::GetDesLength(const TAny* aPtr)</code> </p> </td>
<td class="cellrowborder" valign="top"><p> <code class="codeph">RMessagePtr2::GetDesLength(TInt aParam)</code> </p> </td>
</tr>
<tr class="">
<td class="cellrowborder" valign="top"><p> <code class="codeph">RThread::GetDesMaxLength(const TAny* aPtr)</code> </p> </td>
<td class="cellrowborder" valign="top"><p> <code class="codeph">RMessagePtr2::GetDesMaxLength(TInt aParam)</code> </p> </td>
</tr>
<tr class="bg ">
<td class="cellrowborder" valign="top"><p> <code class="codeph">RThread::ReadL(const TAny* aPtr,TDes8&amp; aDes,TInt  
                anOffset)</code> </p> </td>
<td class="cellrowborder" valign="top"><p> <code class="codeph">RMessagePtr2::ReadL(TInt aParam,TDes8&amp; aDes,TInt  
                aOffset=0)</code> </p> <p>Note: use of <code class="codeph">RThread::ReadL()</code> enclosed
in a TRAP statement can be replaced by the non-leaving <code class="codeph">RMessagePtr2::Read()</code>. </p> </td>
</tr>
<tr class="">
<td class="cellrowborder" valign="top"><p> <code class="codeph">RThread::ReadL(const TAny* aPtr,TDes16&amp; aDes,TInt 
                 anOffset) </code> </p> </td>
<td class="cellrowborder" valign="top"><p> <code class="codeph">RMessagePtr2::ReadL(TInt aParam,TDes16&amp; aDes,TInt 
                 aOffset=0)</code> </p> <p>Note: use of <code class="codeph">RThread::ReadL()</code> enclosed
in a TRAP statement can be replaced by the non-leaving <code class="codeph">RMessagePtr2::Read()</code>. </p> </td>
</tr>
<tr class="bg ">
<td class="cellrowborder" valign="top"><p> <code class="codeph">RThread::WriteL(const TAny* aPtr,const TDesC8&amp;    
              aDes,TInt anOffset) </code> </p> </td>
<td class="cellrowborder" valign="top"><p> <code class="codeph">RMessagePtr2::WriteL(TInt aParam,const TDesC8&amp;    
              aDes,TInt aOffset=0)</code> </p> <p>Note: use of <code class="codeph">RThread::WriteL()</code> enclosed
in a TRAP statement can be replaced by the non-leaving <code class="codeph">RMessagePtr2::Write()</code>. </p> </td>
</tr>
<tr class="">
<td class="cellrowborder" valign="top"><p> <code class="codeph">RThread::WriteL(const TAny* aPtr,const TDesC16&amp;   
               aDes,TInt anOffset)</code> </p> </td>
<td class="cellrowborder" valign="top"><p> <code class="codeph">RMessagePtr2::WriteL(TInt aParam,const TDesC16&amp;   
               aDes,TInt aOffset=0)</code> </p> <p>Note: use of <code class="codeph">RThread::WriteL()</code> enclosed
in a TRAP statement can be replaced by the non-leaving <code class="codeph">RMessagePtr2::Write()</code>. </p> </td>
</tr>
<tr class="bg ">
<td class="cellrowborder" valign="top"><p> <code class="codeph">RThread::RequestComplete(TRequestStatus*&amp; aStatus,TInt
                  aReason)</code> </p> </td>
<td class="cellrowborder" valign="top"><p> <code class="codeph">RMessagePtr2::Complete(TInt aReason)</code> </p> <p>Note:
the only way of signalling the client thread is by completing a message which
the client sent to the session. </p> </td>
</tr>
<tr class="">
<td class="cellrowborder" valign="top"><p> <code class="codeph">RThread::Kill(TInt aReason)</code> </p> </td>
<td class="cellrowborder" valign="top"><p> <code class="codeph">RMessagePtr2::Kill(TInt aReason)</code> </p> </td>
</tr>
<tr class="bg ">
<td class="cellrowborder" valign="top"><p> <code class="codeph">RThread::Terminate(TInt aReason)</code> </p> </td>
<td class="cellrowborder" valign="top"><p> <code class="codeph">RMessagePtr2::Terminate(TInt aReason)</code> </p> </td>
</tr>
<tr class="">
<td class="cellrowborder" valign="top"><p> <code class="codeph">RThread::Panic(const TDesC&amp; aCategory,TInt        
          aReason)</code> </p> </td>
<td class="cellrowborder" valign="top"><p> <code class="codeph">RMessagePtr2::Panic(const TDesC&amp; aCategory,TInt   
               aReason)</code> </p> </td>
</tr>
<tr class="bg ">
<td class="cellrowborder" valign="top"><p> <code class="codeph">RSessionBase::Share()</code> </p> <p>or </p> <p> <code class="codeph">RSessionBase::Share(EExplicitAttach)</code> </p> <p>or </p> <p> <code class="codeph">RSessionBase::Share(EAutoAttach)</code> </p> </td>
<td class="cellrowborder" valign="top"><p> <code class="codeph">RSessionBase::ShareAuto()</code> </p> </td>
</tr>
<tr class="">
<td class="cellrowborder" valign="top"><p> <code class="codeph">RSessionBase::Attach()</code> </p> </td>
<td class="cellrowborder" valign="top"><p>Not required in Version 2. </p> </td>
</tr>
<tr class="bg ">
<td class="cellrowborder" valign="top"><p> <code class="codeph">RSessionBase::Send(TInt aFunction,TAny* aPtr)</code> </p> </td>
<td class="cellrowborder" valign="top"><p> <code class="codeph">RSessionBase::Send(TInt aFunction,const TIpcArgs&amp; 
                 aArgs)</code> </p> </td>
</tr>
<tr class="">
<td class="cellrowborder" valign="top"><p> <code class="codeph">RSessionBase::SendReceive(TInt aFunction,TAny*        
          aPtr,TRequestStatus&amp; aStatus)</code> </p> </td>
<td class="cellrowborder" valign="top"><p> <code class="codeph">RSessionBase::SendReceive(TInt aFunction,const        
          TIpcArgs&amp; aArgs, TRequestStatus&amp; aStatus)</code> </p> </td>
</tr>
<tr class="bg ">
<td class="cellrowborder" valign="top"><p> <code class="codeph">RSessionBase::SendReceive(TInt aFunction,TAny* aPtr)</code> </p> </td>
<td class="cellrowborder" valign="top"><p> <code class="codeph">RSessionBase::SendReceive(TInt aFunction, const       
           TIpcArgs&amp; aArgs)</code> </p> </td>
</tr>
<tr class="">
<td class="cellrowborder" valign="top"><p> <code class="codeph">RSubSessionBase::CreateSubSession(RSessionBase&amp;   
               aSession,TInt aFunction,const TAny* aPtr)</code> </p> </td>
<td class="cellrowborder" valign="top"><p> <code class="codeph">RSubSessionBase::CreateSubSession(RSessionBase, TInt  
                aFunction, const TIpcArgs&amp; aArgs);</code> </p> </td>
</tr>
<tr class="bg ">
<td class="cellrowborder" valign="top"><p> <code class="codeph">RSubSessionBase::Send(TInt aFunction,const TAny*      
            aPtr)</code> </p> </td>
<td class="cellrowborder" valign="top"><p> <code class="codeph">RSubSessionBase::Send(TInt aFunction,const TIpcArgs&amp;
                  aArgs)</code> </p> </td>
</tr>
<tr class="">
<td class="cellrowborder" valign="top"><p> <code class="codeph">RSubSessionBase::SendReceive(TInt aFunction,const TAny*
                  aPtr,TRequestStatus&amp;)</code> </p> </td>
<td class="cellrowborder" valign="top"><p> <code class="codeph">RSubSessionBase::SendReceive(TInt aFunction,const     
             TIpcArgs&amp; aArgs, TRequestStatus&amp;)</code> </p> </td>
</tr>
<tr class="bg ">
<td class="cellrowborder" valign="top"><p> <code class="codeph">RSubSessionBase::SendReceive(TInt aFunction,const TAny*
                  aPtr)</code> </p> </td>
<td class="cellrowborder" valign="top"><p> <code class="codeph">RSubSessionBase::SendReceive(TInt aFunction,const     
             TIpcArgs&amp; aArgs)</code> </p> </td>
</tr>
</tbody>
</table></div> </div>
</div></div></div><div class="footer"><p class="metadata">Last updated February 4th, 2010</p><hr /><div class="copy"> Nokia 2011.</div></div></body>
<!-- Mirrored from devlib.symbian.slions.net/s3/GUID-0A332D6E-E712-5186-8CD0-D5022FA54052.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 27 Mar 2020 06:07:32 GMT -->
</html>